# Licensed under the MIT License
# https://github.com/craigahobbs/ollama-chat/blob/main/LICENSE

include '../ollamaChat.bare'


async function testOllamaChatIndex():
    unittestMockAll({ \
        'systemFetch': { \
            'getConversations': jsonStringify({ \
                'model': 'llm:7b', \
                'conversations': [ \
                    {'id': 'ID', 'model': 'llm:7b', 'title': 'Hello', 'generating': false} \
                ] \
            }) \
        } \
    })

    ollamaChatMain()

    unittestDeepEqual( \
        unittestMockEnd(), \
        [ \
            ['systemFetch', ['getConversations']], \
            ['documentSetTitle', ['Ollama Chat']], \
            ['markdownPrint', ['# Ollama Chat']], \
            ['markdownPrint', ['**Current Model:** llm:7b']], \
            ['elementModelRender', [{'html': 'p', 'elem': [ \
                {'html': 'a', 'attr': {'href': "#var.vView='models'"}, 'elem': {'text': 'Select Model'}}, \
                {'text': stringFromCharCode(160, 160) + '|' + stringFromCharCode(160, 160)}, \
                {'html': 'a', 'attr': {'href': "#var.vView='chat'"}, 'elem': {'text': 'Start Conversation'}}, \
                {'text': stringFromCharCode(160, 160) + '|' + stringFromCharCode(160, 160)}, \
                { \
                    'html': 'a', \
                    'attr': {'style': 'cursor: pointer; user-select: none;'}, \
                    'elem': {'text': 'Add Template'}, \
                    'callback': {'click': '<function>'} \
                } \
            ]}]], \
            ['markdownPrint', ['', '## Conversations']], \
            ['elementModelRender', [ \
                [ \
                    { \
                        'html': 'table', \
                        'elem': [ \
                            { \
                                'html': 'tbody', \
                                'elem': [ \
                                    { \
                                        'html': 'tr', \
                                        'elem': [ \
                                            { \
                                                'html': 'td', \
                                                'attr': {'style': 'min-width: 10em;'}, \
                                                'elem': { \
                                                    'html': 'a', \
                                                    'attr': {'href': "#var.vId='ID'&var.vView='chat'"}, \
                                                    'elem': {'text': 'Hello'} \
                                                } \
                                            }, \
                                            { \
                                                'html': 'td', \
                                                'elem': {'text': 'llm:7b'} \
                                            }, \
                                            { \
                                                'html': 'td', \
                                                'elem': [ \
                                                    { \
                                                        'html': 'a', \
                                                        'attr': {'href': "#var.vAction='conversation'&var.vActionID='ID'"}, \
                                                        'elem': {'text': 'Select'} \
                                                    }, \
                                                    null \
                                                ] \
                                            } \
                                        ] \
                                    } \
                                ] \
                            } \
                        ] \
                    } \
                ] \
            ]], \
            ['markdownPrint', ['', '## Templates']], \
            ['markdownPrint', ['', stringFromCharCode(160, 160, 160, 160) + '*No templates*']] \
        ] \
    )
endfunction
unittestRunTest('testOllamaChatIndex')
